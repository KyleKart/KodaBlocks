<title>KodaBlocks Editor</title>
    <meta content="KodaBlocks" property="og:title" />
    <meta content="KodaBlocks is my custom Blockly editor/workspace which is inspired by my very own Supuraitoresu Scratch mod." property="og:description" />
    <meta content="https://kylekart.github.io/supuraitoresu/blockly/" property="og:url" />
    <meta content="bannerlogo.png" property="og:image" />
    <meta content="#a64dff" data-react-helmet="true" name="theme-color" />
    <div id="logo">
      <img src="logo2.png" alt="Logo" />
    </div>
    <div class="file-edit-view">
      <div class="option">
        <button class="option-label">File</button>
        <div class="dropdown-content">
          <a href="#" onclick="resetWorkspace();">New</a>
          <a href="#" onclick="openWorkspace()">Open</a>
          <a href="#" onclick="saveWorkspace();">Save</a>
        </div>
      </div>
      <div class="option">
        <button class="option-label">Edit</button>
        <div class="dropdown-content">
          <a href="#"></a>
          <a href="#"></a>
          <a href="#"></a>
        </div>
      </div>
      <div class="option">
        <button class="option-label">View</button>
        <div class="dropdown-content">
          <a href="#"></a>
          <a href="#"></a>
          <a href="#"></a>
        </div>
      </div>
    </div>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<script src="https://unpkg.com/blockly/blockly_json.min.js"></script>
<div id="blocklyDiv" style="height: 480px; width: 600px;"></div>
<button id="myButton" onclick="run()">GO</button>
  <div id="console"></div>
<style>
  #logo img {
  width: 70px; /* Change to the desired width */
  height: auto; /* This will automatically adjust the height to maintain the aspect ratio */
  position: absolute;
  left: 20px; /* Adjust as needed */
}
.file-edit-view {
  display: flex;
  flex-direction: row;
  margin-left: 100px;
}

.option {
  display: flex;
  flex-direction: column;
  position: relative;
  margin-right: 20px;
}

.option-label {
  background-color: white;
  border: none;
  cursor: pointer;
  font-size: 14px;
  padding: 10px;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
  z-index: 1;
  top: 30px;
  width: 80px;
}

.dropdown-content a {
  color: black;
  text-align: center;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

.option:hover .dropdown-content {
  display: block;
}
/* Button */
/* Button */
#myButton{
 background-image:url("flag_circle_FILL1_wght400_GRAD0_opsz48.svg");
 padding-right:15px;
 border-style:none;
 padding-left:15px;
 padding-top:15px;
 padding-bottom:15px;
 transform:translatex(551px) translatey(-480px);
 color:rgba(0,0,0,0);
 background-color:rgba(240,240,240,0);
 background-size:auto;
}
/* Console */
#console{
 position:relative;
 left:362px;
 transform: translatex(256px) translatey(-254px);
 top:-279px;
 bottom:auto !important;
 max-height: 500px; /* set a fixed height */
  overflow-y: auto; /* add a vertical scroll bar when necessary */
  width: 40rem;
  background: aliceblue;
}
  </style>
<script>
// Get the console element
const consoleElem = document.getElementById('console');
console.log(consoleElem)

// Function to log a message to the console
function logToConsole(message) {
  // Create a new paragraph element with the message
  const newMessage = document.createElement('p');
  newMessage.textContent = message;
  console.log(newMessage)
  // Append the new element to the console
  consoleElem.appendChild(newMessage);
}
function clearLog() {
    const consoleElem = document.getElementById('console');
    consoleElem.innerHTML = '';
}
function resetWorkspace() {
    Blockly.mainWorkspace.clear();
    clearLog();
}
Blockly.defineBlocksWithJsonArray([{
  "type": "string_length",
  "message0": 'length of %1',
  "args0": [
    {
      "type": "input_value",
      "name": "VALUE",
      "check": "String"
    }
  ],
  "output": "Number",
  "colour": 160,
  "tooltip": "Returns number of letters in the provided text.",
  "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
},
{
  "type": "lolz",
  "message0": "%1",
  "args0": [
    {
      "type": "field_checkbox",
      "name": "NAME",
      "checked": true
    }
  ],
  "colour": 210,
  "tooltip": "",
  "helpUrl": ""
},
{
  "type": "blok_normal",
  "message0": "%1 %2 %3 %4 %5",
  "args0": [
    {
      "type": "field_label_serializable",
      "name": "01",
      "text": ""
    },
    {
      "type": "field_input",
      "name": "02",
      "text": "default"
    },
    {
      "type": "field_angle",
      "name": "03",
      "angle": 90
    },
    {
      "type": "field_dropdown",
      "name": "04",
      "options": [
        [
          "option1",
          "OPTIONNAME"
        ],
        [
          "option2",
          "OPTIONNAME2"
        ],
        [
          "option3",
          "OPTIONNAME3"
        ]
      ]
    },
    {
      "type": "field_checkbox",
      "name": "05",
      "checked": true
    }
  ],
  "previousStatement": null,
  "nextStatement": null,
  "colour": 230,
  "tooltip": "",
  "helpUrl": ""
},
{
  "type": "alert",
  "message0": "Alert %1",
  "args0": [
  {
      "type": "field_input",
      "name": "NAME",
      "text": "Alert!"
    }
  ],
  "inputsInline": true,
  "previousStatement": null,
  "nextStatement": null,
  "colour": "#5abb37",
  "tooltip": "",
  "helpUrl": ""
},
{
  "type": "prompt",
  "message0": "Prompt %1",
  "args0": [
  {
      "type": "field_input",
      "name": "NAME",
      "text": "Prompt?"
    }
  ],
  "inputsInline": true,
  "previousStatement": null,
  "nextStatement": null,
  "colour": "#5abb37",
  "tooltip": "",
  "helpUrl": ""
},
{
  "type": "confirm",
  "message0": "Confirm %1",
  "args0": [
  {
      "type": "field_input",
      "name": "NAME",
      "text": "Confirm?"
    }
  ],
  "inputsInline": true,
  "previousStatement": null,
  "nextStatement": null,
  "colour": "#5abb37",
  "tooltip": "",
  "helpUrl": ""
},
{
  "type": "log",
  "message0": "Log %1",
  "args0": [
  {
      "type": "field_input",
      "name": "NAME",
      "text": "Log!"
    }
  ],
  "inputsInline": true,
  "previousStatement": null,
  "nextStatement": null,
  "colour": "#5abb37",
  "tooltip": "",
  "helpUrl": ""
},
{
  "type": "clear",
  "message0": "Clear log",
  "inputsInline": true,
  "previousStatement": null,
  "nextStatement": null,
  "colour": "#5abb37",
  "tooltip": "",
  "helpUrl": ""
},
{
  "type": "go_click",
  "message0": "%1",
  "args0": [
    {
      "type": "field_image",
      "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' height='48' viewBox='0 -960 960 960' width='48'%3E%3Cpath d='M229.825-120Q217-120 208.5-128.625T200-150v-620q0-12.75 8.625-21.375T230-800h289q10.5 0 18.75 6.5T548-776l14 62h208q12.75 0 21.375 8.625T800-684v310q0 12.75-8.625 21.375T770-344H568q-10.5 0-18.75-6.5T539-367l-14-62H260v279q0 12.75-8.675 21.375-8.676 8.625-21.5 8.625Z'/%3E%3C/svg%3E",
      "width": 20,
      "height": 20,
      "alt": "*",
      "flipRtl": false
    }
  ],
  "nextStatement": null,
  "colour": "#ee7d16",
  "tooltip": "",
  "helpUrl": ""
},
{
  "type": "ifelse",
  "message0": "if %1 do %2",
  "args0": [
    {
      "type": "input_value",
      "name": "iffy"
    },
    {
      "type": "input_statement",
      "name": "elsey"
    }
  ],
  "inputsInline": false,
  "previousStatement": null,
  "nextStatement": null,
  "colour": "#cc5b22",
  "tooltip": "",
  "helpUrl": ""
}]);

const toolbox = {
  "kind": "categoryToolbox",
  "contents": [
    {
  "kind": "category",
  "name": "Events",
  'colour':'#ee7d16',

  "contents": [
  {
      "kind": "label",
      "text": "Blocks for triggering events.",
    },
    {
      "kind": "label",
      "text": "Like in Scratch.",
    },
    {
      "kind": "block",
      "type": "go_click"
    }
  ]
},
    {
      "kind": "category",
      "name": "Control",
      'colour':'#cc5b22',
      "contents": [
      {
      "kind": "label",
      "text": "Blocks for program flow control.",
    },
    {
      "kind": "label",
      "text": "Like in Scratch.",
    },
        {
          "kind": "block",
          "type": "controls_if"
        },
      ]
    },
    {
      "kind": "category",
      "name": "Operator",
      'colour': '#4a6cd4',
      "contents": [
      {
      "kind": "label",
      "text": "Blocks for Math and logic.",
    },
    {
      "kind": "label",
      "text": "Like in Scratch.",
    },
    {
      "kind": "label",
      "text": "Logic",
    },
        {
          "kind": "block",
          "type": "logic_compare"
        },
        {
          "kind": "block",
          "type": "logic_operation"
        },
        {
          "kind": "block",
          "type": "logic_boolean"
        },
        {
      "kind": "label",
      "text": "Text",
    },
        {
          "kind": "block",
          "type": "text"
        },
        {
      "kind": "block",
      "type": "string_length"
    },
        {
      "kind": "label",
      "text": "Math",
    },
        {
      "kind": "block",
      "type": "math_number"
    },
    {
      "kind": "block",
      "type": "math_arithmetic"
    },
      ]
    },
    {
      "kind": "category",
      "name": "Output",
      'colour':'#5abb37',
            "contents": [
            {
      "kind": "label",
      "text": "Blocks for outputting data like text.",
    },
    {
      "kind": "label",
      "text": "Not in Scratch.",
    },
        {
          "kind": "block",
          "type": "alert", 
        },
        {
          "kind": "block",
          "type": "log", 
        },
        {
          "kind": "block",
          "type": "clear", 
        },
      ]
    },
    {
  "kind": "sep",
},
    {
    "kind": "category",
    "name": "TestZone",
    "contents": [
    {
      "kind": "label",
      "text": "Unfinished or Experminetal Blocks",
    },
    {
      "kind": "label",
      "text": "Use at your own risk!"
    },
    {
          "kind": "block",
          "type": "prompt", 
        },
        {
          "kind": "block",
          "type": "confirm", 
        },
        {
      "kind": "block",
      "type": "ifelse"
    },
    {
      "kind": "block",
      "type": "lolz"
    },
    {
      "kind": "block",
      "type": "blok_normal"
    }
    ]
  },
  ]
}
Blockly.JavaScript['alert'] = function(block) {
  var text_name = block.getFieldValue('NAME');
  var code = '...;\n';
  alert(text_name);
  return code;
};
Blockly.JavaScript['prompt'] = function(block) {
  var text_name = block.getFieldValue('NAME');
  var code = '...;\n';
  prompt(text_name);
  return code;
};
Blockly.JavaScript['confirm'] = function(block) {
  var text_name = block.getFieldValue('NAME');
  var code = '...;\n';
  confirm(text_name);
  return code;
};
Blockly.JavaScript['log'] = function(block) {
  var text_name = block.getFieldValue('NAME');
  var code = '...;\n';
  logToConsole(text_name);
  return code;
};
Blockly.JavaScript['clear'] = function(block) {
  var code = '...;\n';
  clearLog();
  return code;
};
Blockly.JavaScript['go_click'] = function(block) {
  var nextBlock = block.getNextBlock();
  while (nextBlock) {
    var code = Blockly.JavaScript[nextBlock.type](nextBlock);
    nextBlock = nextBlock.getNextBlock();
  }
};
Blockly.JavaScript['ifelse'] = function(block) {
  var value_iffy = Blockly.JavaScript.valueToCode(block, 'iffy', Blockly.JavaScript.ORDER_NONE);
  console.log(value_iffy)
  var statements_elsey = Blockly.JavaScript.statementToCode(block, 'elsey');
  console.log(statements_elsey)
  var code = 'if (' + value_iffy + ') {\n' + statements_elsey + '}';
  console.log(code)
  return code;
};
  var run = function(){
    Blockly.JavaScript.addReservedWords('code');
    var code = Blockly.JavaScript.workspaceToCode(workspace);
}

const workspace = Blockly.inject('blocklyDiv', {toolbox: toolbox}, {renderer: 'zelos'});
var myCategory = workspace.getToolbox().getCategoryByName("TestZone");
if (myCategory) {
  myCategory.setDescription("This is my category description!");
}

const options = document.querySelectorAll('.option');

options.forEach(function(option) {
  const dropdown = option.querySelector('.dropdown-content');

  option.addEventListener('click', function(event) {
    event.stopPropagation();
    const openDropdown = document.querySelector('.dropdown-content.show');
    if (openDropdown && openDropdown !== dropdown) {
      openDropdown.classList.remove('show');
    }
    dropdown.classList.toggle('show');
  });
});

document.addEventListener('click', function(event) {
  const dropdowns = document.querySelectorAll('.dropdown-content');
  dropdowns.forEach(function(dropdown) {
    dropdown.classList.remove('show');
  });
});
function saveWorkspace() {
    var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
    var xmlText = Blockly.Xml.domToText(xml);
    download(xmlText, 'myProject.kbp', 'text/plain');
}

function download(data, filename, type) {
    var file = new Blob([data], {type: type});
    var a = document.createElement('a');
    var url = URL.createObjectURL(file);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(function() {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }, 0);
}
function openWorkspace() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.kbp';
  input.onchange = function(event) {
    var files = event.target.files;
    if (files.length == 0) {
      return;
    }
    var file = files[0];
    var reader = new FileReader();
    reader.onload = function(event) {
      var xmlString = event.target.result;
      var dom = Blockly.Xml.textToDom(xmlString);
      Blockly.Xml.domToWorkspace(dom, Blockly.mainWorkspace);
    }
    reader.readAsText(file);
  }
  input.click();
}
 </script>
